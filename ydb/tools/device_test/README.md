# Yandex Database Device Test Tool

## Описание

Утилита предназначена для тестирования и оценки производительности накопителей позволяет подавать нагрузку несколькими
различными способами, в том числе характерным для слоя хранения YDB, а также выполнять оценку параметров
производительности.

**ВНИМАНИЕ! В ходе тестирования данные на тестируемом накопителе будут перезаписаны тестовым паттерном.**

Описание серии экспериментов подается на вход в файле конфигурации (по умолчанию `cfg.txt`). Поддерживается работа с
накопителями на жестких магнитных дисках ROT, тверодтельными накопителями SSD и NVMe. Результаты теста могут быть выданы
в формате wiki-разметки, человеко-читаемом human формате или в виде json документа.

## Файл конфигурации

Поддерживаеются следующие виды тестовой нагрузки:
- `AioTestList` - подача запросов на чтение/запись через libaio.
- `TrimTestList` - подача запросов на trim (blkdiscard) блоками указанного размера, перед тестом выполняется запись данных.
- `PDiksTestList` - подача нагрузки через код слоя хранения YDB (PDisk).

### Параметры `AioTestList`
Описывают запросы на чтение/запись через libaio.

- `DurationSeconds` - длительность подачи нагрузки в секундах.
- `RequestSize` - размер запроса в байтах.
- `QueueDepth` - количество конкуретно отправляемых запросов в штуках.
- `ReadProportion` - доля запросов на чтение, доля запросов на запись определяется как `(1.0 - ReadProportion)`. Например, чтобы подавалось одинаковое количество запросов на чтение и на запись, следует использовать значение `ReadProportion` равное `0.5`.

### Параметры `TrimTestList`
Описывают запросоы на trim (blkdiscard) блоками указанного размера, перед тестом выполняется запись данных.

- `DurationSeconds` - длительность подачи нагрузки в секундах.
- `RequestSize` - размер запроса в байтах.

### Параметры `PDiksTestList`
Описывают нагрузку, подаваемую через код слоя хранения YDB (PDisk).

Одновременно может быть запущено несколько источников нагрузки.
- `PDiskReadLoadStart` - описание источника нагрузки на чтение.
- `PDiskLoadStart` - описание источника нагрузки на запись.

В ходе нормальной работы PDisk подает на SSD носители Trim запросы. В тесте можно включать/выключать это поведение при поощи параметра `EnableTrim`.

#### Параметры `PDiskReadLoadStart`
Описаывают источник нагрузки на чтение.

- `Tag` - уникальный целочисленный идентификатр источника нагрузки.
- `PDiskId` - адрес PDisk, должен иметь значение 1
- `PDiskGuid` - глобально-уникальный идентификатор PDisk, должен иметь значение `12345`
- `VDiskId` - адрес `VDisk`, используемый для подачи нагрузки, должен иметь значение `{ GroupID: 1 GroupGeneration: 5 Ring: 1 Domain: 1 VDisk: 1 }`
- `Chunks` - набор запиисей, который определяет количество используемых чанков (по умолчанию чанк имеет размер 128 мегабайт), каждый чанк содержит конфигурируемое количество слотов (блоков, запись которых целиком выполняется одним запросом), задается параметром `Slots`, в штуках. Запросы подаются в разные чанки, при подаче запросов на случайные чанки, 
- `DurationSeconds` - длительность подачи нагрузки в секундах.
- `IntervalMsMin` - зарезервированный для дальнейшего использования параметр, должен иметь значение `0`.
- `IntervalMsMax` - зарезервированный для дальнейшего использования параметр, должен иметь значение `0`.
- `InFlightWrites` - количество конкуретно отправляемых запросов в штуках.
- `Sequential` - параметр управляет тем, по каким адресам выполняются запросы. При значении `true` запрсы выполняются для последовательно расположенных блоков данных. При значении `false` запросы выполняются для случайно распложенных блоков данных.
- `IsWardenlessTest` - зарезервированный для дальнейшего использования параметр, должен иметь значение `true`.

#### Параметры `PDiskLoadStart` 
Описывают источник нагрузки на запись.
Имеет те же настройки, что и `PDiskReadLoadStart`, а так же дополнительный параметр `LogMode`.

- `LogMode` - режим записи в "лог" метаданных о записи "в чанк". Есть следующие режимы:
  - `LOG_PARALLEL` - запись в лог выполняется конкурентно с записью в чанк, операция считается завершенной после завершения и записи в лог и записи в чанк.
  - `LOG_SEQUENTIAL` - запись в лог выполняется после успешного завершения записи в чанк, вся операция считается завершенной после завершения записи в лог, так же как это делает текущая версия VDisk. 
  - `LOG_NONE` - запись в лог не выполняется, операция считается завершенной после завершения записи в чанк.


 

